ENTER_KEY = 13
$ ->
  $(".todo-list table tbody").sortable()

  todoHeaderHandlers = new TodoHeaderHandlers()
  todoHeaderHandlers.showActionButtons()
  todoHeaderHandlers.editTodoHeader()
  todoHeaderHandlers.removeTodo()
  todoHeaderHandlers.updateTodoHeader()

  todoBarHandlers = new TodoBarHandlers()
  todoBarHandlers.button()
  todoBarHandlers.keypress()

  todoListHandlers = new TodoListHandlers()
  todoListHandlers.showActions()
  todoListHandlers.finishTask()
  todoListHandlers.editTask()
  todoListHandlers.taskKeypress()
  todoListHandlers.taskBlur()
  todoListHandlers.removeTask()

class TodoHeaderHandlers
  showActionButtons: ->
    $('.content .list')
      .on 'mouseover', 'article .todo-header', (e) ->
        $(@).find('ul').removeClass('hidden')
      .on 'mouseout', 'article .todo-header', (e) ->
        $(@).find('ul').addClass('hidden')

  editTodoHeader: ->
    $('.content .list').on 'click', '.todo-header .todo-action-edit', (e) ->
      e.preventDefault()
      project_header = $(@).parents('.todo-header')
      project_title = project_header.find('h3').text()
      project_header
        .addClass('edit-mode')
        .find('input')
        .val(project_title)
        .focus()

  removeTodo: ->
    $('.content .list').on 'click', '.todo-header .todo-action-remove', (e) ->
      e.preventDefault()
      if confirm 'Are you sure ?'
        project = $(@).parents('article')
        project_id = project.data('project-id')
        project_path = "<%= Rails.application.routes.url_helpers.project_path(0) %>"
        project_path = project_path.replace('0', project_id)
        $.ajax
          url: project_path
          method: 'DELETE'
        .done (data) ->
          project.slideUp (e) =>
            @.remove

  updateTodoHeader: ->
    $('.content .list').on 'blur', '.todo-header input', (e) =>
      @._cancelEditing($(e.currentTarget))

    $('.content .list').on 'keypress', '.todo-header input', (e) =>
      if e.which is ENTER_KEY
        @._cancelEditing($(e.currentTarget))

  _cancelEditing: (input) ->
    project_title = input.val()
    project_id = $(input).parents('article').data('project-id')
    project_path = "<%= Rails.application.routes.url_helpers.project_path(0) %>"
    project_path = project_path.replace('0', project_id)
    $.ajax
      url: project_path
      method: 'PUT'
      data: { project: { title:  project_title } }
    .done (data) ->
      input.parent('.todo-header')
        .removeClass('edit-mode')
        .find('h3')
        .text(project_title)

class TodoBarHandlers
  button: ->
    $('.todo-bar-new button').on 'click', (e) =>
      e.preventDefault()
      @._newTask($(e.currentTarget))

  keypress: ->
    $('.todo-bar-new input').on 'keypress', (e) =>
      if e.which is ENTER_KEY
        e.preventDefault()
        @._newTask($(e.currentTarget).next('button'))

  _newTask: (button) ->
    # project = $(@).parents('article')
    # project_id = project.data('project-id')
    # project_path = "<%= Rails.application.routes.url_helpers.project_path(0) %>"
    # project_path = project_path.replace('0', project_id)
    $.ajax
      url: project_path
      method: 'DELETE'
    .done (data) ->
      project.slideUp (e) =>
        @.remove

    # taskInput = button.prev('input')
    # taskText = taskInput.val()
    # taskTable = button.parents('article').find('table tbody')
    # newTaskRow = taskTable.find('tr:last').clone()
    # newTaskRow.find('.todo-list-task p').text(taskText)
    # taskTable.append(newTaskRow)
    # taskInput.val('')

class TodoListHandlers
  showActions: ->
    $('.todo-list')
      .on 'mouseover', 'tr', ->
        $(@).find('ul').removeClass('hidden')
      .on 'mouseout', 'tr', ->
        $(@).find('ul').addClass('hidden')

  finishTask: ->
    $('.todo-list table').on 'change', 'tr .todo-list-checkbox input', (e) =>
      @._completeTask($(e.currentTarget))

  editTask: ->
    $('.todo-list').on 'click', 'tr .todo-list-task-edit', (e) =>
      e.preventDefault()
      todoListTask = $(e.currentTarget).parents('tr').find('.todo-list-task')
      unless todoListTask.hasClass('edit-mode')
        todoListTask.addClass('edit-mode')
        textToBeEdited = todoListTask.find('p').text()
        todoListTask.append(@._editTaskInput()).find('input').val(textToBeEdited).focus()

  taskKeypress: ->
    $('.todo-list').on 'keypress', 'tr .todo-list-task input', (e) =>
      if e.which is ENTER_KEY
        e.preventDefault()
        @._cancelTaskEditing($(e.currentTarget))

  taskBlur: ->
    $('.todo-list').on 'blur', 'tr .todo-list-task input', (e) =>
      e.preventDefault()
      @._cancelTaskEditing($(e.currentTarget))

  removeTask: ->
    $('.todo-list').on 'click', 'tr .todo-list-task-delete', (e) ->
      e.preventDefault()
      if confirm 'Are you sure ?'
        $(@).parents('tr').remove()

  _completeTask: (elem) ->
    elem.parents('tr').toggleClass('completed-task')

  _cancelTaskEditing: (input) ->
    parent = input.parent()
    parent.find('p').text(input.val())
    parent.find('input')?.remove()
#    parent.hasClass('edit-mode')?removeClass('edit-mode')
    parent.removeClass('edit-mode')

  _editTaskInput: () ->
    "<input type='text' name='' value=''>"